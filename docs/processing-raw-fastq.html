<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Processing raw fastq | Fish eDNA</title>
  <meta name="description" content="Processing raw fastq | Fish eDNA" />
  <meta name="generator" content="bookdown 0.42 and GitBook 2.6.7" />

  <meta property="og:title" content="Processing raw fastq | Fish eDNA" />
  <meta property="og:type" content="book" />
  
  
  <meta name="github-repo" content="rstudio/bookdown-demo" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Processing raw fastq | Fish eDNA" />
  
  
  




  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="required-files-scripts-and-programs.html"/>
<link rel="next" href="taxonomic-classification.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<link href="libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet" />
<script src="libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet" />
<script src="libs/datatables-binding-0.33/datatables.js"></script>
<link href="libs/dt-core-1.13.6/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="libs/dt-core-1.13.6/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="libs/dt-core-1.13.6/js/jquery.dataTables.min.js"></script>
<link href="libs/crosstalk-1.2.1/css/crosstalk.min.css" rel="stylesheet" />
<script src="libs/crosstalk-1.2.1/js/crosstalk.min.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Introduction</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#objectives"><i class="fa fa-check"></i>Objectives</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#dataset"><i class="fa fa-check"></i>Dataset</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#alberta-fishes"><i class="fa fa-check"></i>Alberta fishes</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#methods-and-their-associated-available-databases"><i class="fa fa-check"></i>Methods and their associated available databases</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#representation-of-alberta-freshwater-fishes-in-databases"><i class="fa fa-check"></i>Representation of Alberta freshwater fishes in databases</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#notes-on-otus-vs-asvs"><i class="fa fa-check"></i>Notes on OTUs vs ASVs</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="required-files-scripts-and-programs.html"><a href="required-files-scripts-and-programs.html"><i class="fa fa-check"></i>Required files, scripts and programs</a>
<ul>
<li class="chapter" data-level="" data-path="required-files-scripts-and-programs.html"><a href="required-files-scripts-and-programs.html#programs"><i class="fa fa-check"></i>Programs</a></li>
<li class="chapter" data-level="" data-path="required-files-scripts-and-programs.html"><a href="required-files-scripts-and-programs.html#databases"><i class="fa fa-check"></i>Databases</a></li>
<li class="chapter" data-level="" data-path="required-files-scripts-and-programs.html"><a href="required-files-scripts-and-programs.html#scripts"><i class="fa fa-check"></i>Scripts</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="processing-raw-fastq.html"><a href="processing-raw-fastq.html"><i class="fa fa-check"></i>Processing raw fastq</a>
<ul>
<li class="chapter" data-level="" data-path="processing-raw-fastq.html"><a href="processing-raw-fastq.html#dada2"><i class="fa fa-check"></i>DADA2</a></li>
<li class="chapter" data-level="" data-path="processing-raw-fastq.html"><a href="processing-raw-fastq.html#barque"><i class="fa fa-check"></i>barque</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="taxonomic-classification.html"><a href="taxonomic-classification.html"><i class="fa fa-check"></i>Taxonomic classification</a></li>
<li class="chapter" data-level="" data-path="evaluate-performance-of-databases.html"><a href="evaluate-performance-of-databases.html"><i class="fa fa-check"></i>Evaluate performance of databases</a>
<ul>
<li class="chapter" data-level="" data-path="evaluate-performance-of-databases.html"><a href="evaluate-performance-of-databases.html#description"><i class="fa fa-check"></i>Description</a></li>
<li class="chapter" data-level="" data-path="evaluate-performance-of-databases.html"><a href="evaluate-performance-of-databases.html#methods"><i class="fa fa-check"></i>Methods</a></li>
<li class="chapter" data-level="" data-path="evaluate-performance-of-databases.html"><a href="evaluate-performance-of-databases.html#implementing-cvi-with-our-data"><i class="fa fa-check"></i>Implementing CVI with our data</a></li>
<li class="chapter" data-level="" data-path="evaluate-performance-of-databases.html"><a href="evaluate-performance-of-databases.html#generate-benchmark-datasets"><i class="fa fa-check"></i>Generate benchmark datasets</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="taxonomy-cross-validation-by-identity-taxxi.html"><a href="taxonomy-cross-validation-by-identity-taxxi.html"><i class="fa fa-check"></i>Taxonomy cross validation by identity (TAXXI)</a>
<ul>
<li class="chapter" data-level="" data-path="taxonomy-cross-validation-by-identity-taxxi.html"><a href="taxonomy-cross-validation-by-identity-taxxi.html#description-1"><i class="fa fa-check"></i>Description</a></li>
<li class="chapter" data-level="" data-path="taxonomy-cross-validation-by-identity-taxxi.html"><a href="taxonomy-cross-validation-by-identity-taxxi.html#methods-1"><i class="fa fa-check"></i>Methods</a></li>
<li class="chapter" data-level="" data-path="taxonomy-cross-validation-by-identity-taxxi.html"><a href="taxonomy-cross-validation-by-identity-taxxi.html#implementing-cvi-with-our-data-1"><i class="fa fa-check"></i>Implementing CVI with our data</a></li>
<li class="chapter" data-level="" data-path="taxonomy-cross-validation-by-identity-taxxi.html"><a href="taxonomy-cross-validation-by-identity-taxxi.html#generate-benchmark-datasets-1"><i class="fa fa-check"></i>Generate benchmark datasets</a></li>
<li class="chapter" data-level="" data-path="taxonomy-cross-validation-by-identity-taxxi.html"><a href="taxonomy-cross-validation-by-identity-taxxi.html#generate-predictions"><i class="fa fa-check"></i>Generate predictions</a>
<ul>
<li class="chapter" data-level="" data-path="taxonomy-cross-validation-by-identity-taxxi.html"><a href="taxonomy-cross-validation-by-identity-taxxi.html#rdp-classifier"><i class="fa fa-check"></i>RDP Classifier</a></li>
<li class="chapter" data-level="" data-path="taxonomy-cross-validation-by-identity-taxxi.html"><a href="taxonomy-cross-validation-by-identity-taxxi.html#vsearch"><i class="fa fa-check"></i>VSEARCH</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="taxonomy-cross-validation-by-identity-taxxi.html"><a href="taxonomy-cross-validation-by-identity-taxxi.html#cvi-metrics"><i class="fa fa-check"></i>CVI metrics</a>
<ul>
<li class="chapter" data-level="" data-path="taxonomy-cross-validation-by-identity-taxxi.html"><a href="taxonomy-cross-validation-by-identity-taxxi.html#script-to-evaluate-prediction"><i class="fa fa-check"></i>Script to evaluate prediction</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="generating-custom-database-of-the-12s-marker-gene.html"><a href="generating-custom-database-of-the-12s-marker-gene.html"><i class="fa fa-check"></i>Generating custom database of the 12S marker gene</a>
<ul>
<li class="chapter" data-level="" data-path="generating-custom-database-of-the-12s-marker-gene.html"><a href="generating-custom-database-of-the-12s-marker-gene.html#evaluate-resolution-blindspots"><i class="fa fa-check"></i>Evaluate resolution blindspots</a></li>
<li class="chapter" data-level="" data-path="generating-custom-database-of-the-12s-marker-gene.html"><a href="generating-custom-database-of-the-12s-marker-gene.html#notes-on-resolution-blindspot"><i class="fa fa-check"></i>Notes on resolution blindspot</a></li>
<li class="chapter" data-level="" data-path="generating-custom-database-of-the-12s-marker-gene.html"><a href="generating-custom-database-of-the-12s-marker-gene.html#assessing-hybrids"><i class="fa fa-check"></i>Assessing hybrids</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="generating-custom-database.html"><a href="generating-custom-database.html"><i class="fa fa-check"></i>Generating custom database</a></li>
<li class="chapter" data-level="" data-path="generating-mock-communities.html"><a href="generating-mock-communities.html"><i class="fa fa-check"></i>Generating mock communities</a></li>
<li class="chapter" data-level="" data-path="supplementary-workflow.html"><a href="supplementary-workflow.html"><i class="fa fa-check"></i>Supplementary workflow</a>
<ul>
<li class="chapter" data-level="" data-path="supplementary-workflow.html"><a href="supplementary-workflow.html#curating-databases-for-distance-matrix"><i class="fa fa-check"></i>Curating databases for distance matrix</a>
<ul>
<li class="chapter" data-level="" data-path="supplementary-workflow.html"><a href="supplementary-workflow.html#rdp"><i class="fa fa-check"></i>RDP</a></li>
<li class="chapter" data-level="" data-path="supplementary-workflow.html"><a href="supplementary-workflow.html#barque-1"><i class="fa fa-check"></i>Barque</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="random-subsample-10-sequences.html"><a href="random-subsample-10-sequences.html"><i class="fa fa-check"></i>Random subsample 10 sequences</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Fish eDNA</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="processing-raw-fastq" class="section level1 unnumbered hasAnchor">
<h1>Processing raw fastq<a href="processing-raw-fastq.html#processing-raw-fastq" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>The two following FASTQ processing workflow were used in the context of this study :</p>
<ol style="list-style-type: decimal">
<li>DADA2</li>
<li>barque</li>
</ol>
<div id="dada2" class="section level2 unnumbered hasAnchor">
<h2>DADA2<a href="processing-raw-fastq.html#dada2" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="processing-raw-fastq.html#cb1-1" tabindex="-1"></a><span class="co"># :::::::::::::::::::::::::::::::::::::::::::: 12S MARKER GENE :::::::::::::::::::::::::::::::::::::::::::::::::</span></span>
<span id="cb1-2"><a href="processing-raw-fastq.html#cb1-2" tabindex="-1"></a></span>
<span id="cb1-3"><a href="processing-raw-fastq.html#cb1-3" tabindex="-1"></a><span class="do">################################################################################</span></span>
<span id="cb1-4"><a href="processing-raw-fastq.html#cb1-4" tabindex="-1"></a><span class="do">#### ----------------------------- libraries ------------------------------ ####</span></span>
<span id="cb1-5"><a href="processing-raw-fastq.html#cb1-5" tabindex="-1"></a><span class="do">################################################################################</span></span>
<span id="cb1-6"><a href="processing-raw-fastq.html#cb1-6" tabindex="-1"></a></span>
<span id="cb1-7"><a href="processing-raw-fastq.html#cb1-7" tabindex="-1"></a><span class="fu">library</span>(dada2)</span>
<span id="cb1-8"><a href="processing-raw-fastq.html#cb1-8" tabindex="-1"></a><span class="fu">library</span>(ShortRead)</span>
<span id="cb1-9"><a href="processing-raw-fastq.html#cb1-9" tabindex="-1"></a><span class="fu">library</span>(Biostrings)</span>
<span id="cb1-10"><a href="processing-raw-fastq.html#cb1-10" tabindex="-1"></a><span class="fu">library</span>(reticulate)</span>
<span id="cb1-11"><a href="processing-raw-fastq.html#cb1-11" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-12"><a href="processing-raw-fastq.html#cb1-12" tabindex="-1"></a><span class="fu">library</span>(phyloseq)</span>
<span id="cb1-13"><a href="processing-raw-fastq.html#cb1-13" tabindex="-1"></a></span>
<span id="cb1-14"><a href="processing-raw-fastq.html#cb1-14" tabindex="-1"></a><span class="do">################################################################################</span></span>
<span id="cb1-15"><a href="processing-raw-fastq.html#cb1-15" tabindex="-1"></a><span class="do">#### -------------------------- Prepare files ----------------------------- ####</span></span>
<span id="cb1-16"><a href="processing-raw-fastq.html#cb1-16" tabindex="-1"></a><span class="do">################################################################################</span></span>
<span id="cb1-17"><a href="processing-raw-fastq.html#cb1-17" tabindex="-1"></a></span>
<span id="cb1-18"><a href="processing-raw-fastq.html#cb1-18" tabindex="-1"></a>path <span class="ot">=</span> <span class="st">&quot;/home/kvilleneuve/fish_edna/raw/12s&quot;</span></span>
<span id="cb1-19"><a href="processing-raw-fastq.html#cb1-19" tabindex="-1"></a></span>
<span id="cb1-20"><a href="processing-raw-fastq.html#cb1-20" tabindex="-1"></a>myfiles <span class="ot">=</span> <span class="fu">list.files</span>(<span class="at">path =</span> path, <span class="at">pattern=</span><span class="st">&quot;fastq.gz&quot;</span>)</span>
<span id="cb1-21"><a href="processing-raw-fastq.html#cb1-21" tabindex="-1"></a></span>
<span id="cb1-22"><a href="processing-raw-fastq.html#cb1-22" tabindex="-1"></a>fnFs <span class="ot">=</span> <span class="fu">sort</span>(<span class="fu">list.files</span>(path,<span class="at">pattern =</span> <span class="st">&quot;_R1_001.fastq.gz&quot;</span>,<span class="at">full.names=</span><span class="cn">TRUE</span>))</span>
<span id="cb1-23"><a href="processing-raw-fastq.html#cb1-23" tabindex="-1"></a>fnRs <span class="ot">=</span> <span class="fu">sort</span>(<span class="fu">list.files</span>(path,<span class="at">pattern =</span> <span class="st">&quot;_R2_001.fastq.gz&quot;</span>,<span class="at">full.names=</span><span class="cn">TRUE</span>))</span>
<span id="cb1-24"><a href="processing-raw-fastq.html#cb1-24" tabindex="-1"></a>sample.names <span class="ot">=</span> <span class="fu">sapply</span>(<span class="fu">strsplit</span>(<span class="fu">basename</span>(fnFs), <span class="st">&quot;_&quot;</span>), <span class="st">`</span><span class="at">[</span><span class="st">`</span>, <span class="dv">1</span>)</span>
<span id="cb1-25"><a href="processing-raw-fastq.html#cb1-25" tabindex="-1"></a></span>
<span id="cb1-26"><a href="processing-raw-fastq.html#cb1-26" tabindex="-1"></a></span>
<span id="cb1-27"><a href="processing-raw-fastq.html#cb1-27" tabindex="-1"></a><span class="do">################################################################################</span></span>
<span id="cb1-28"><a href="processing-raw-fastq.html#cb1-28" tabindex="-1"></a><span class="do">#### --------------------------- Plot quality ----------------------------- ####</span></span>
<span id="cb1-29"><a href="processing-raw-fastq.html#cb1-29" tabindex="-1"></a><span class="do">################################################################################</span></span>
<span id="cb1-30"><a href="processing-raw-fastq.html#cb1-30" tabindex="-1"></a></span>
<span id="cb1-31"><a href="processing-raw-fastq.html#cb1-31" tabindex="-1"></a><span class="fu">plotQualityProfile</span>(fnFs.filtN) <span class="co">#read quality drops after about 225bp</span></span>
<span id="cb1-32"><a href="processing-raw-fastq.html#cb1-32" tabindex="-1"></a><span class="fu">plotQualityProfile</span>(fnRs.filtN) <span class="co">#read quality drops around 225bp</span></span>
<span id="cb1-33"><a href="processing-raw-fastq.html#cb1-33" tabindex="-1"></a></span>
<span id="cb1-34"><a href="processing-raw-fastq.html#cb1-34" tabindex="-1"></a><span class="do">################################################################################</span></span>
<span id="cb1-35"><a href="processing-raw-fastq.html#cb1-35" tabindex="-1"></a><span class="do">#### ------------------------ Finding primers ----------------------------- ####</span></span>
<span id="cb1-36"><a href="processing-raw-fastq.html#cb1-36" tabindex="-1"></a><span class="do">################################################################################</span></span>
<span id="cb1-37"><a href="processing-raw-fastq.html#cb1-37" tabindex="-1"></a></span>
<span id="cb1-38"><a href="processing-raw-fastq.html#cb1-38" tabindex="-1"></a>FWD <span class="ot">=</span> <span class="st">&quot;CCGGTAAAACTCGTGCCAGC&quot;</span></span>
<span id="cb1-39"><a href="processing-raw-fastq.html#cb1-39" tabindex="-1"></a>REV <span class="ot">=</span> <span class="st">&quot;CATAGTGGGGTATCTAATCCCAGTTTG&quot;</span></span>
<span id="cb1-40"><a href="processing-raw-fastq.html#cb1-40" tabindex="-1"></a></span>
<span id="cb1-41"><a href="processing-raw-fastq.html#cb1-41" tabindex="-1"></a>allOrients <span class="ot">=</span> <span class="cf">function</span>(primer){</span>
<span id="cb1-42"><a href="processing-raw-fastq.html#cb1-42" tabindex="-1"></a>  <span class="fu">require</span>(Biostrings)</span>
<span id="cb1-43"><a href="processing-raw-fastq.html#cb1-43" tabindex="-1"></a>  dna <span class="ot">=</span> <span class="fu">DNAString</span>(primer)</span>
<span id="cb1-44"><a href="processing-raw-fastq.html#cb1-44" tabindex="-1"></a>  orients <span class="ot">=</span> <span class="fu">c</span>(<span class="at">Forward =</span> dna, <span class="at">Complement =</span> <span class="fu">complement</span>(dna), <span class="at">Reverse =</span> <span class="fu">reverse</span>(dna), <span class="at">RevComp =</span> <span class="fu">reverseComplement</span>(dna))</span>
<span id="cb1-45"><a href="processing-raw-fastq.html#cb1-45" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">sapply</span>(orients,toString))</span>
<span id="cb1-46"><a href="processing-raw-fastq.html#cb1-46" tabindex="-1"></a>}</span>
<span id="cb1-47"><a href="processing-raw-fastq.html#cb1-47" tabindex="-1"></a></span>
<span id="cb1-48"><a href="processing-raw-fastq.html#cb1-48" tabindex="-1"></a>FWD.orients <span class="ot">=</span> <span class="fu">allOrients</span>(FWD)</span>
<span id="cb1-49"><a href="processing-raw-fastq.html#cb1-49" tabindex="-1"></a>REV.orients <span class="ot">=</span> <span class="fu">allOrients</span>(REV)</span>
<span id="cb1-50"><a href="processing-raw-fastq.html#cb1-50" tabindex="-1"></a></span>
<span id="cb1-51"><a href="processing-raw-fastq.html#cb1-51" tabindex="-1"></a>primerHits <span class="ot">=</span> <span class="cf">function</span>(primer,fn){</span>
<span id="cb1-52"><a href="processing-raw-fastq.html#cb1-52" tabindex="-1"></a>  nhits <span class="ot">=</span> <span class="fu">vcountPattern</span>(primer,<span class="fu">sread</span>(<span class="fu">readFastq</span>(fn)),<span class="at">fixed=</span><span class="cn">FALSE</span>)</span>
<span id="cb1-53"><a href="processing-raw-fastq.html#cb1-53" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">sum</span>(nhits<span class="sc">&gt;</span><span class="dv">0</span>))</span>
<span id="cb1-54"><a href="processing-raw-fastq.html#cb1-54" tabindex="-1"></a>}</span>
<span id="cb1-55"><a href="processing-raw-fastq.html#cb1-55" tabindex="-1"></a></span>
<span id="cb1-56"><a href="processing-raw-fastq.html#cb1-56" tabindex="-1"></a><span class="fu">rbind</span>(<span class="at">FWD.ForwardReads=</span><span class="fu">sapply</span>(FWD.orients,primerHits,fnFs[[<span class="dv">1</span>]]),</span>
<span id="cb1-57"><a href="processing-raw-fastq.html#cb1-57" tabindex="-1"></a>      <span class="at">FWD.ReverseReads=</span><span class="fu">sapply</span>(FWD.orients,primerHits,fnRs[[<span class="dv">1</span>]]),</span>
<span id="cb1-58"><a href="processing-raw-fastq.html#cb1-58" tabindex="-1"></a>      <span class="at">REV.ForwardReads=</span><span class="fu">sapply</span>(REV.orients,primerHits,fnFs[[<span class="dv">1</span>]]),</span>
<span id="cb1-59"><a href="processing-raw-fastq.html#cb1-59" tabindex="-1"></a>      <span class="at">REV.ReverseReads=</span><span class="fu">sapply</span>(REV.orients,primerHits,fnRs[[<span class="dv">1</span>]]))</span>
<span id="cb1-60"><a href="processing-raw-fastq.html#cb1-60" tabindex="-1"></a></span>
<span id="cb1-61"><a href="processing-raw-fastq.html#cb1-61" tabindex="-1"></a></span>
<span id="cb1-62"><a href="processing-raw-fastq.html#cb1-62" tabindex="-1"></a><span class="do">################################################################################</span></span>
<span id="cb1-63"><a href="processing-raw-fastq.html#cb1-63" tabindex="-1"></a><span class="do">#### ------------------------ Removing primers ---------------------------- ####</span></span>
<span id="cb1-64"><a href="processing-raw-fastq.html#cb1-64" tabindex="-1"></a><span class="do">################################################################################</span></span>
<span id="cb1-65"><a href="processing-raw-fastq.html#cb1-65" tabindex="-1"></a></span>
<span id="cb1-66"><a href="processing-raw-fastq.html#cb1-66" tabindex="-1"></a>cutadapt <span class="ot">=</span> <span class="st">&quot;/home/kvilleneuve/anaconda/envs/cutadapt/bin/cutadapt&quot;</span></span>
<span id="cb1-67"><a href="processing-raw-fastq.html#cb1-67" tabindex="-1"></a><span class="fu">system2</span>(cutadapt, <span class="at">args =</span> <span class="st">&#39;--version&#39;</span>)</span>
<span id="cb1-68"><a href="processing-raw-fastq.html#cb1-68" tabindex="-1"></a></span>
<span id="cb1-69"><a href="processing-raw-fastq.html#cb1-69" tabindex="-1"></a>path.cut <span class="ot">=</span> <span class="fu">file.path</span>(path, <span class="st">&quot;cutadapt&quot;</span>) <span class="co"># create folder cutadapt in directory path_raw</span></span>
<span id="cb1-70"><a href="processing-raw-fastq.html#cb1-70" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">dir.exists</span>(path.cut)) <span class="fu">dir.create</span>(path.cut)</span>
<span id="cb1-71"><a href="processing-raw-fastq.html#cb1-71" tabindex="-1"></a>fnFs.cut <span class="ot">=</span> <span class="fu">file.path</span>(path.cut, <span class="fu">basename</span>(fnFs))</span>
<span id="cb1-72"><a href="processing-raw-fastq.html#cb1-72" tabindex="-1"></a>fnRs.cut <span class="ot">=</span> <span class="fu">file.path</span>(path.cut, <span class="fu">basename</span>(fnRs))</span>
<span id="cb1-73"><a href="processing-raw-fastq.html#cb1-73" tabindex="-1"></a></span>
<span id="cb1-74"><a href="processing-raw-fastq.html#cb1-74" tabindex="-1"></a>FWD.RC <span class="ot">=</span> dada2<span class="sc">:::</span><span class="fu">rc</span>(FWD)</span>
<span id="cb1-75"><a href="processing-raw-fastq.html#cb1-75" tabindex="-1"></a>REV.RC <span class="ot">=</span> dada2<span class="sc">:::</span><span class="fu">rc</span>(REV)</span>
<span id="cb1-76"><a href="processing-raw-fastq.html#cb1-76" tabindex="-1"></a></span>
<span id="cb1-77"><a href="processing-raw-fastq.html#cb1-77" tabindex="-1"></a>R1.flags <span class="ot">=</span> <span class="fu">paste</span>(<span class="st">&quot;-g&quot;</span>, FWD, <span class="st">&quot;-a&quot;</span>, REV.RC)</span>
<span id="cb1-78"><a href="processing-raw-fastq.html#cb1-78" tabindex="-1"></a>R2.flags <span class="ot">=</span> <span class="fu">paste</span>(<span class="st">&quot;-G&quot;</span>, REV, <span class="st">&quot;-A&quot;</span>, FWD.RC)</span>
<span id="cb1-79"><a href="processing-raw-fastq.html#cb1-79" tabindex="-1"></a></span>
<span id="cb1-80"><a href="processing-raw-fastq.html#cb1-80" tabindex="-1"></a><span class="co">#Trim primers with cutadapt</span></span>
<span id="cb1-81"><a href="processing-raw-fastq.html#cb1-81" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">seq_along</span>(fnFs)){</span>
<span id="cb1-82"><a href="processing-raw-fastq.html#cb1-82" tabindex="-1"></a>  <span class="fu">system2</span>(cutadapt, <span class="at">arg =</span> <span class="fu">c</span>(R1.flags, R2.flags, <span class="st">&quot;-n&quot;</span>, <span class="dv">2</span>, <span class="st">&quot;-m&quot;</span>, <span class="dv">10</span>, <span class="st">&quot;-o&quot;</span>, </span>
<span id="cb1-83"><a href="processing-raw-fastq.html#cb1-83" tabindex="-1"></a>                            fnFs.cut[i],<span class="st">&quot;-p&quot;</span>,fnRs.cut[i],fnFs[i],fnRs[i]))</span>
<span id="cb1-84"><a href="processing-raw-fastq.html#cb1-84" tabindex="-1"></a>}</span>
<span id="cb1-85"><a href="processing-raw-fastq.html#cb1-85" tabindex="-1"></a></span>
<span id="cb1-86"><a href="processing-raw-fastq.html#cb1-86" tabindex="-1"></a><span class="co"># Sanity check to confirm primers were removed </span></span>
<span id="cb1-87"><a href="processing-raw-fastq.html#cb1-87" tabindex="-1"></a><span class="fu">rbind</span>(<span class="at">FWD.ForwardReads=</span><span class="fu">sapply</span>(FWD.orients,primerHits,fnFs.cut[[<span class="dv">1</span>]]),</span>
<span id="cb1-88"><a href="processing-raw-fastq.html#cb1-88" tabindex="-1"></a>      <span class="at">FWD.ReverseReads=</span><span class="fu">sapply</span>(FWD.orients,primerHits,fnRs.cut[[<span class="dv">1</span>]]),</span>
<span id="cb1-89"><a href="processing-raw-fastq.html#cb1-89" tabindex="-1"></a>      <span class="at">REV.ForwardReads=</span><span class="fu">sapply</span>(REV.orients,primerHits,fnFs.cut[[<span class="dv">1</span>]]),</span>
<span id="cb1-90"><a href="processing-raw-fastq.html#cb1-90" tabindex="-1"></a>      <span class="at">REV.ReverseReads=</span><span class="fu">sapply</span>(REV.orients,primerHits,fnRs.cut[[<span class="dv">1</span>]]))</span>
<span id="cb1-91"><a href="processing-raw-fastq.html#cb1-91" tabindex="-1"></a>                                                                                                                                                                   </span>
<span id="cb1-92"><a href="processing-raw-fastq.html#cb1-92" tabindex="-1"></a><span class="do">################################################################################</span></span>
<span id="cb1-93"><a href="processing-raw-fastq.html#cb1-93" tabindex="-1"></a><span class="do">#### ------------------------- Filter and trim ---------------------------- ####</span></span>
<span id="cb1-94"><a href="processing-raw-fastq.html#cb1-94" tabindex="-1"></a><span class="do">################################################################################</span></span>
<span id="cb1-95"><a href="processing-raw-fastq.html#cb1-95" tabindex="-1"></a></span>
<span id="cb1-96"><a href="processing-raw-fastq.html#cb1-96" tabindex="-1"></a>cutFs <span class="ot">=</span> <span class="fu">sort</span>(<span class="fu">list.files</span>(path.cut, <span class="at">pattern =</span><span class="st">&quot;_R1_001.fastq.gz&quot;</span>, <span class="at">full.names=</span><span class="cn">TRUE</span>))</span>
<span id="cb1-97"><a href="processing-raw-fastq.html#cb1-97" tabindex="-1"></a>cutRs <span class="ot">=</span> <span class="fu">sort</span>(<span class="fu">list.files</span>(path.cut, <span class="at">pattern =</span><span class="st">&quot;_R2_001.fastq.gz&quot;</span>, <span class="at">full.names=</span><span class="cn">TRUE</span>))</span>
<span id="cb1-98"><a href="processing-raw-fastq.html#cb1-98" tabindex="-1"></a></span>
<span id="cb1-99"><a href="processing-raw-fastq.html#cb1-99" tabindex="-1"></a></span>
<span id="cb1-100"><a href="processing-raw-fastq.html#cb1-100" tabindex="-1"></a>filtFs <span class="ot">=</span> <span class="fu">file.path</span>(path,<span class="st">&quot;filtered&quot;</span>, <span class="fu">basename</span>(cutFs))</span>
<span id="cb1-101"><a href="processing-raw-fastq.html#cb1-101" tabindex="-1"></a>filtRs <span class="ot">=</span> <span class="fu">file.path</span>(path,<span class="st">&quot;filtered&quot;</span>, <span class="fu">basename</span>(cutRs))</span>
<span id="cb1-102"><a href="processing-raw-fastq.html#cb1-102" tabindex="-1"></a></span>
<span id="cb1-103"><a href="processing-raw-fastq.html#cb1-103" tabindex="-1"></a>out <span class="ot">=</span> <span class="fu">filterAndTrim</span>(cutFs, filtFs, cutRs, filtRs, <span class="at">maxN =</span> <span class="dv">0</span>, <span class="at">maxEE =</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>),<span class="at">truncQ =</span> <span class="dv">2</span>,</span>
<span id="cb1-104"><a href="processing-raw-fastq.html#cb1-104" tabindex="-1"></a>                    <span class="at">minLen =</span> <span class="dv">50</span>, <span class="at">rm.phix =</span> <span class="cn">TRUE</span>, <span class="at">compress =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-105"><a href="processing-raw-fastq.html#cb1-105" tabindex="-1"></a></span>
<span id="cb1-106"><a href="processing-raw-fastq.html#cb1-106" tabindex="-1"></a><span class="fu">head</span>(out)</span>
<span id="cb1-107"><a href="processing-raw-fastq.html#cb1-107" tabindex="-1"></a>exists <span class="ot">=</span> <span class="fu">file.exists</span>(filtFs) <span class="co"># All files have reads</span></span>
<span id="cb1-108"><a href="processing-raw-fastq.html#cb1-108" tabindex="-1"></a></span>
<span id="cb1-109"><a href="processing-raw-fastq.html#cb1-109" tabindex="-1"></a>errF <span class="ot">=</span> <span class="fu">learnErrors</span>(filtFs[exists], <span class="at">multithread =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-110"><a href="processing-raw-fastq.html#cb1-110" tabindex="-1"></a>errR <span class="ot">=</span> <span class="fu">learnErrors</span>(filtRs[exists], <span class="at">multithread =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-111"><a href="processing-raw-fastq.html#cb1-111" tabindex="-1"></a></span>
<span id="cb1-112"><a href="processing-raw-fastq.html#cb1-112" tabindex="-1"></a><span class="co">#plotErrors(errF,nominalQ=TRUE)</span></span>
<span id="cb1-113"><a href="processing-raw-fastq.html#cb1-113" tabindex="-1"></a><span class="co">#plotErrors(errR,nominalQ=TRUE)</span></span>
<span id="cb1-114"><a href="processing-raw-fastq.html#cb1-114" tabindex="-1"></a></span>
<span id="cb1-115"><a href="processing-raw-fastq.html#cb1-115" tabindex="-1"></a>derepFs <span class="ot">=</span> <span class="fu">derepFastq</span>(filtFs[exists],<span class="at">verbose=</span><span class="cn">TRUE</span>)</span>
<span id="cb1-116"><a href="processing-raw-fastq.html#cb1-116" tabindex="-1"></a>derepRs <span class="ot">=</span> <span class="fu">derepFastq</span>(filtRs[exists],<span class="at">verbose=</span><span class="cn">TRUE</span>)</span>
<span id="cb1-117"><a href="processing-raw-fastq.html#cb1-117" tabindex="-1"></a></span>
<span id="cb1-118"><a href="processing-raw-fastq.html#cb1-118" tabindex="-1"></a>dadaFs <span class="ot">=</span> <span class="fu">dada</span>(filtFs, <span class="at">err =</span> errF, <span class="at">multithread =</span> <span class="cn">TRUE</span>, <span class="at">pool =</span> <span class="st">&quot;pseudo&quot;</span>)</span>
<span id="cb1-119"><a href="processing-raw-fastq.html#cb1-119" tabindex="-1"></a>dadaRs <span class="ot">=</span> <span class="fu">dada</span>(filtRs, <span class="at">err =</span> errR, <span class="at">multithread =</span> <span class="cn">TRUE</span>, <span class="at">pool =</span> <span class="st">&quot;pseudo&quot;</span>)</span>
<span id="cb1-120"><a href="processing-raw-fastq.html#cb1-120" tabindex="-1"></a></span>
<span id="cb1-121"><a href="processing-raw-fastq.html#cb1-121" tabindex="-1"></a>mergers <span class="ot">=</span> <span class="fu">mergePairs</span>(dadaFs, filtFs, dadaRs, filtRs, <span class="at">verbose=</span><span class="cn">TRUE</span>)</span>
<span id="cb1-122"><a href="processing-raw-fastq.html#cb1-122" tabindex="-1"></a><span class="fu">names</span>(mergers) <span class="ot">=</span> sample.names[exists]</span>
<span id="cb1-123"><a href="processing-raw-fastq.html#cb1-123" tabindex="-1"></a>seqtab <span class="ot">=</span> <span class="fu">makeSequenceTable</span>(mergers)</span>
<span id="cb1-124"><a href="processing-raw-fastq.html#cb1-124" tabindex="-1"></a><span class="fu">table</span>(<span class="fu">nchar</span>(<span class="fu">getSequences</span>(seqtab))) <span class="co"># Most sequences are 259 bp long</span></span>
<span id="cb1-125"><a href="processing-raw-fastq.html#cb1-125" tabindex="-1"></a><span class="co">#seqtab2 = seqtab[,nchar(colnames(seqtab)) %in% 200:300]</span></span>
<span id="cb1-126"><a href="processing-raw-fastq.html#cb1-126" tabindex="-1"></a></span>
<span id="cb1-127"><a href="processing-raw-fastq.html#cb1-127" tabindex="-1"></a>seqtab.nochim <span class="ot">=</span> <span class="fu">removeBimeraDenovo</span>(seqtab, <span class="at">method=</span><span class="st">&quot;consensus&quot;</span>, <span class="at">multithread=</span><span class="cn">TRUE</span>,<span class="at">verbose=</span><span class="cn">TRUE</span>)</span>
<span id="cb1-128"><a href="processing-raw-fastq.html#cb1-128" tabindex="-1"></a><span class="fu">sum</span>(seqtab.nochim)<span class="sc">/</span><span class="fu">sum</span>(seqtab) <span class="co"># 99.9% of reads remain</span></span>
<span id="cb1-129"><a href="processing-raw-fastq.html#cb1-129" tabindex="-1"></a></span>
<span id="cb1-130"><a href="processing-raw-fastq.html#cb1-130" tabindex="-1"></a>getN <span class="ot">=</span> <span class="cf">function</span>(x) <span class="fu">sum</span>(<span class="fu">getUniques</span>(x))</span>
<span id="cb1-131"><a href="processing-raw-fastq.html#cb1-131" tabindex="-1"></a>out_ex <span class="ot">=</span> <span class="fu">row.names</span>(out)[exists]</span>
<span id="cb1-132"><a href="processing-raw-fastq.html#cb1-132" tabindex="-1"></a></span>
<span id="cb1-133"><a href="processing-raw-fastq.html#cb1-133" tabindex="-1"></a>track <span class="ot">=</span> <span class="fu">cbind</span>(out,<span class="fu">sapply</span>(dadaFs,getN),<span class="fu">sapply</span>(dadaRs,getN),<span class="fu">sapply</span>(mergers,getN),</span>
<span id="cb1-134"><a href="processing-raw-fastq.html#cb1-134" tabindex="-1"></a>              <span class="fu">rowSums</span>(seqtab.nochim))</span>
<span id="cb1-135"><a href="processing-raw-fastq.html#cb1-135" tabindex="-1"></a></span>
<span id="cb1-136"><a href="processing-raw-fastq.html#cb1-136" tabindex="-1"></a><span class="fu">colnames</span>(track) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;input&quot;</span>,<span class="st">&quot;filtered&quot;</span>,<span class="st">&quot;denoisedF&quot;</span>,<span class="st">&quot;denoisedR&quot;</span>,<span class="st">&quot;merged&quot;</span>,<span class="st">&quot;nochim&quot;</span>)</span>
<span id="cb1-137"><a href="processing-raw-fastq.html#cb1-137" tabindex="-1"></a></span>
<span id="cb1-138"><a href="processing-raw-fastq.html#cb1-138" tabindex="-1"></a>ps_base <span class="ot">=</span> <span class="fu">phyloseq</span>(<span class="fu">otu_table</span>(seqtab.nochim,<span class="at">taxa_are_rows =</span> <span class="cn">FALSE</span>))</span>
<span id="cb1-139"><a href="processing-raw-fastq.html#cb1-139" tabindex="-1"></a>dna <span class="ot">=</span> Biostrings<span class="sc">::</span><span class="fu">DNAStringSet</span>(<span class="fu">taxa_names</span>(ps_base))</span>
<span id="cb1-140"><a href="processing-raw-fastq.html#cb1-140" tabindex="-1"></a><span class="fu">names</span>(dna) <span class="ot">=</span> <span class="fu">taxa_names</span>(ps_base)</span>
<span id="cb1-141"><a href="processing-raw-fastq.html#cb1-141" tabindex="-1"></a>ps_base <span class="ot">=</span> <span class="fu">merge_phyloseq</span>(ps_base,dna)</span>
<span id="cb1-142"><a href="processing-raw-fastq.html#cb1-142" tabindex="-1"></a>ps_sub <span class="ot">=</span> <span class="fu">prune_taxa</span>(<span class="fu">taxa_sums</span>(ps_base) <span class="sc">&gt;</span> <span class="dv">2</span>, ps_base) <span class="co"># 2982 taxa remain</span></span>
<span id="cb1-143"><a href="processing-raw-fastq.html#cb1-143" tabindex="-1"></a></span>
<span id="cb1-144"><a href="processing-raw-fastq.html#cb1-144" tabindex="-1"></a><span class="fu">taxa_names</span>(ps_sub)<span class="ot">&lt;-</span><span class="fu">paste0</span>(<span class="st">&quot;ASV&quot;</span>,<span class="fu">seq</span>(<span class="fu">ntaxa</span>(ps_sub)))</span>
<span id="cb1-145"><a href="processing-raw-fastq.html#cb1-145" tabindex="-1"></a>ps_sub <span class="sc">%&gt;%</span></span>
<span id="cb1-146"><a href="processing-raw-fastq.html#cb1-146" tabindex="-1"></a>  <span class="fu">refseq</span>() <span class="sc">%&gt;%</span></span>
<span id="cb1-147"><a href="processing-raw-fastq.html#cb1-147" tabindex="-1"></a>  Biostrings<span class="sc">::</span><span class="fu">writeXStringSet</span>(<span class="st">&quot;/home/kvilleneuve/fish_edna/results/12s_dada2_biostring4annotation.fna&quot;</span>, </span>
<span id="cb1-148"><a href="processing-raw-fastq.html#cb1-148" tabindex="-1"></a>                              <span class="at">append =</span> <span class="cn">FALSE</span>, <span class="at">compress =</span> <span class="cn">FALSE</span>, <span class="at">compression_level =</span> <span class="cn">NA</span>, <span class="at">format =</span> <span class="st">&quot;fasta&quot;</span>)</span>
<span id="cb1-149"><a href="processing-raw-fastq.html#cb1-149" tabindex="-1"></a><span class="fu">saveRDS</span>(ps_sub, <span class="at">file =</span> <span class="st">&quot;/home/kvilleneuve/fish_edna/results/12s_dada2_rdpraw_phylo.rds&quot;</span>)</span>
<span id="cb1-150"><a href="processing-raw-fastq.html#cb1-150" tabindex="-1"></a></span>
<span id="cb1-151"><a href="processing-raw-fastq.html#cb1-151" tabindex="-1"></a><span class="co"># :::::::::::::::::::::::::::::::::::::::::::: COI MARKER GENE :::::::::::::::::::::::::::::::::::::::::::::::::</span></span>
<span id="cb1-152"><a href="processing-raw-fastq.html#cb1-152" tabindex="-1"></a></span>
<span id="cb1-153"><a href="processing-raw-fastq.html#cb1-153" tabindex="-1"></a>path <span class="ot">=</span> <span class="st">&quot;/home/kvilleneuve/fish_edna/raw/coi&quot;</span></span>
<span id="cb1-154"><a href="processing-raw-fastq.html#cb1-154" tabindex="-1"></a></span>
<span id="cb1-155"><a href="processing-raw-fastq.html#cb1-155" tabindex="-1"></a>myfiles <span class="ot">=</span> <span class="fu">list.files</span>(<span class="at">path =</span> path, <span class="at">pattern=</span><span class="st">&quot;fastq.gz&quot;</span>)</span>
<span id="cb1-156"><a href="processing-raw-fastq.html#cb1-156" tabindex="-1"></a></span>
<span id="cb1-157"><a href="processing-raw-fastq.html#cb1-157" tabindex="-1"></a>fnFs <span class="ot">=</span> <span class="fu">sort</span>(<span class="fu">list.files</span>(path,<span class="at">pattern =</span> <span class="st">&quot;_R1_001.fastq.gz&quot;</span>,<span class="at">full.names=</span><span class="cn">TRUE</span>))</span>
<span id="cb1-158"><a href="processing-raw-fastq.html#cb1-158" tabindex="-1"></a>fnRs <span class="ot">=</span> <span class="fu">sort</span>(<span class="fu">list.files</span>(path,<span class="at">pattern =</span> <span class="st">&quot;_R2_001.fastq.gz&quot;</span>,<span class="at">full.names=</span><span class="cn">TRUE</span>))</span>
<span id="cb1-159"><a href="processing-raw-fastq.html#cb1-159" tabindex="-1"></a></span>
<span id="cb1-160"><a href="processing-raw-fastq.html#cb1-160" tabindex="-1"></a><span class="do">################################################################################</span></span>
<span id="cb1-161"><a href="processing-raw-fastq.html#cb1-161" tabindex="-1"></a><span class="do">#### ------------------------ Finding primers ----------------------------- ####</span></span>
<span id="cb1-162"><a href="processing-raw-fastq.html#cb1-162" tabindex="-1"></a><span class="do">################################################################################</span></span>
<span id="cb1-163"><a href="processing-raw-fastq.html#cb1-163" tabindex="-1"></a></span>
<span id="cb1-164"><a href="processing-raw-fastq.html#cb1-164" tabindex="-1"></a>FWD <span class="ot">=</span> <span class="st">&quot;CGTATTTGGYGCYTGRGCCGGRATAGT&quot;</span></span>
<span id="cb1-165"><a href="processing-raw-fastq.html#cb1-165" tabindex="-1"></a>REV <span class="ot">=</span> <span class="st">&quot;CARAARCTYATRTTRTTYATTCG&quot;</span></span>
<span id="cb1-166"><a href="processing-raw-fastq.html#cb1-166" tabindex="-1"></a></span>
<span id="cb1-167"><a href="processing-raw-fastq.html#cb1-167" tabindex="-1"></a>allOrients<span class="ot">&lt;-</span><span class="cf">function</span>(primer){</span>
<span id="cb1-168"><a href="processing-raw-fastq.html#cb1-168" tabindex="-1"></a>  <span class="fu">require</span>(Biostrings)</span>
<span id="cb1-169"><a href="processing-raw-fastq.html#cb1-169" tabindex="-1"></a>  dna <span class="ot">=</span> <span class="fu">DNAString</span>(primer)</span>
<span id="cb1-170"><a href="processing-raw-fastq.html#cb1-170" tabindex="-1"></a>  orients <span class="ot">=</span> <span class="fu">c</span>(<span class="at">Forward =</span> dna, <span class="at">Complement =</span> <span class="fu">complement</span>(dna), <span class="at">Reverse =</span> <span class="fu">reverse</span>(dna), <span class="at">RevComp =</span> <span class="fu">reverseComplement</span>(dna))</span>
<span id="cb1-171"><a href="processing-raw-fastq.html#cb1-171" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">sapply</span>(orients,toString))</span>
<span id="cb1-172"><a href="processing-raw-fastq.html#cb1-172" tabindex="-1"></a>}</span>
<span id="cb1-173"><a href="processing-raw-fastq.html#cb1-173" tabindex="-1"></a></span>
<span id="cb1-174"><a href="processing-raw-fastq.html#cb1-174" tabindex="-1"></a>FWD.orients <span class="ot">=</span> <span class="fu">allOrients</span>(FWD)</span>
<span id="cb1-175"><a href="processing-raw-fastq.html#cb1-175" tabindex="-1"></a>REV.orients <span class="ot">=</span> <span class="fu">allOrients</span>(REV)</span>
<span id="cb1-176"><a href="processing-raw-fastq.html#cb1-176" tabindex="-1"></a></span>
<span id="cb1-177"><a href="processing-raw-fastq.html#cb1-177" tabindex="-1"></a>primerHits <span class="ot">=</span> <span class="cf">function</span>(primer,fn){</span>
<span id="cb1-178"><a href="processing-raw-fastq.html#cb1-178" tabindex="-1"></a>  nhits<span class="ot">&lt;-</span><span class="fu">vcountPattern</span>(primer,<span class="fu">sread</span>(<span class="fu">readFastq</span>(fn)),<span class="at">fixed =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1-179"><a href="processing-raw-fastq.html#cb1-179" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">sum</span>(nhits<span class="sc">&gt;</span><span class="dv">0</span>))</span>
<span id="cb1-180"><a href="processing-raw-fastq.html#cb1-180" tabindex="-1"></a>}</span>
<span id="cb1-181"><a href="processing-raw-fastq.html#cb1-181" tabindex="-1"></a></span>
<span id="cb1-182"><a href="processing-raw-fastq.html#cb1-182" tabindex="-1"></a><span class="fu">rbind</span>(<span class="at">FWD.ForwardReads =</span> <span class="fu">sapply</span>(FWD.orients,primerHits,fnFs[[<span class="dv">1</span>]]),</span>
<span id="cb1-183"><a href="processing-raw-fastq.html#cb1-183" tabindex="-1"></a>      <span class="at">FWD.ReverseReads =</span> <span class="fu">sapply</span>(FWD.orients,primerHits,fnRs[[<span class="dv">1</span>]]),</span>
<span id="cb1-184"><a href="processing-raw-fastq.html#cb1-184" tabindex="-1"></a>      <span class="at">REV.ForwardReads =</span> <span class="fu">sapply</span>(REV.orients,primerHits,fnFs[[<span class="dv">1</span>]]),</span>
<span id="cb1-185"><a href="processing-raw-fastq.html#cb1-185" tabindex="-1"></a>      <span class="at">REV.ReverseReads =</span> <span class="fu">sapply</span>(REV.orients,primerHits,fnRs[[<span class="dv">1</span>]]))</span>
<span id="cb1-186"><a href="processing-raw-fastq.html#cb1-186" tabindex="-1"></a></span>
<span id="cb1-187"><a href="processing-raw-fastq.html#cb1-187" tabindex="-1"></a><span class="do">################################################################################</span></span>
<span id="cb1-188"><a href="processing-raw-fastq.html#cb1-188" tabindex="-1"></a><span class="do">#### ------------------------ Removing primers ---------------------------- ####</span></span>
<span id="cb1-189"><a href="processing-raw-fastq.html#cb1-189" tabindex="-1"></a><span class="do">################################################################################</span></span>
<span id="cb1-190"><a href="processing-raw-fastq.html#cb1-190" tabindex="-1"></a></span>
<span id="cb1-191"><a href="processing-raw-fastq.html#cb1-191" tabindex="-1"></a>cutadapt <span class="ot">=</span> <span class="st">&quot;/home/kvilleneuve/anaconda/envs/cutadapt/bin/cutadapt&quot;</span></span>
<span id="cb1-192"><a href="processing-raw-fastq.html#cb1-192" tabindex="-1"></a><span class="fu">system2</span>(cutadapt, <span class="at">args =</span> <span class="st">&#39;--version&#39;</span>)</span>
<span id="cb1-193"><a href="processing-raw-fastq.html#cb1-193" tabindex="-1"></a></span>
<span id="cb1-194"><a href="processing-raw-fastq.html#cb1-194" tabindex="-1"></a>path.cut <span class="ot">=</span> <span class="fu">file.path</span>(path,<span class="st">&quot;cutadapt&quot;</span>)</span>
<span id="cb1-195"><a href="processing-raw-fastq.html#cb1-195" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">dir.exists</span>(path.cut))<span class="fu">dir.create</span>(path.cut)</span>
<span id="cb1-196"><a href="processing-raw-fastq.html#cb1-196" tabindex="-1"></a>fnFs.cut <span class="ot">=</span> <span class="fu">file.path</span>(path.cut,<span class="fu">basename</span>(fnFs))</span>
<span id="cb1-197"><a href="processing-raw-fastq.html#cb1-197" tabindex="-1"></a>fnRs.cut <span class="ot">=</span> <span class="fu">file.path</span>(path.cut,<span class="fu">basename</span>(fnRs))</span>
<span id="cb1-198"><a href="processing-raw-fastq.html#cb1-198" tabindex="-1"></a></span>
<span id="cb1-199"><a href="processing-raw-fastq.html#cb1-199" tabindex="-1"></a>FWD.RC <span class="ot">=</span> dada2<span class="sc">:::</span><span class="fu">rc</span>(FWD)</span>
<span id="cb1-200"><a href="processing-raw-fastq.html#cb1-200" tabindex="-1"></a>REV.RC <span class="ot">=</span> dada2<span class="sc">:::</span><span class="fu">rc</span>(REV)</span>
<span id="cb1-201"><a href="processing-raw-fastq.html#cb1-201" tabindex="-1"></a></span>
<span id="cb1-202"><a href="processing-raw-fastq.html#cb1-202" tabindex="-1"></a>R1.flags <span class="ot">=</span> <span class="fu">paste</span>(<span class="st">&quot;-g&quot;</span>,FWD,<span class="st">&quot;-a&quot;</span>,REV.RC)</span>
<span id="cb1-203"><a href="processing-raw-fastq.html#cb1-203" tabindex="-1"></a>R2.flags <span class="ot">=</span> <span class="fu">paste</span>(<span class="st">&quot;-G&quot;</span>,REV,<span class="st">&quot;-A&quot;</span>,FWD.RC)</span>
<span id="cb1-204"><a href="processing-raw-fastq.html#cb1-204" tabindex="-1"></a></span>
<span id="cb1-205"><a href="processing-raw-fastq.html#cb1-205" tabindex="-1"></a></span>
<span id="cb1-206"><a href="processing-raw-fastq.html#cb1-206" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">seq_along</span>(fnFs)){</span>
<span id="cb1-207"><a href="processing-raw-fastq.html#cb1-207" tabindex="-1"></a>  <span class="fu">system2</span>(cutadapt, <span class="at">arg =</span> <span class="fu">c</span>(R1.flags,R2.flags,<span class="st">&quot;-n&quot;</span>,<span class="dv">2</span>,<span class="st">&quot;-m&quot;</span>,<span class="dv">10</span>,<span class="st">&quot;-o&quot;</span>,fnFs.cut[i],<span class="st">&quot;-p&quot;</span>,fnRs.cut[i],fnFs[i],fnRs[i]))</span>
<span id="cb1-208"><a href="processing-raw-fastq.html#cb1-208" tabindex="-1"></a>}</span>
<span id="cb1-209"><a href="processing-raw-fastq.html#cb1-209" tabindex="-1"></a></span>
<span id="cb1-210"><a href="processing-raw-fastq.html#cb1-210" tabindex="-1"></a><span class="fu">rbind</span>(<span class="at">FWD.ForwardReads =</span> <span class="fu">sapply</span>(FWD.orients,primerHits,fnFs.cut[[<span class="dv">1</span>]]),</span>
<span id="cb1-211"><a href="processing-raw-fastq.html#cb1-211" tabindex="-1"></a>      <span class="at">FWD.ReverseReads =</span> <span class="fu">sapply</span>(FWD.orients,primerHits,fnRs.cut[[<span class="dv">1</span>]]),</span>
<span id="cb1-212"><a href="processing-raw-fastq.html#cb1-212" tabindex="-1"></a>      <span class="at">REV.ForwardReads =</span> <span class="fu">sapply</span>(REV.orients,primerHits,fnFs.cut[[<span class="dv">1</span>]]),</span>
<span id="cb1-213"><a href="processing-raw-fastq.html#cb1-213" tabindex="-1"></a>      <span class="at">REV.ReverseReads =</span> <span class="fu">sapply</span>(REV.orients,primerHits,fnRs.cut[[<span class="dv">1</span>]])</span>
<span id="cb1-214"><a href="processing-raw-fastq.html#cb1-214" tabindex="-1"></a>)</span>
<span id="cb1-215"><a href="processing-raw-fastq.html#cb1-215" tabindex="-1"></a></span>
<span id="cb1-216"><a href="processing-raw-fastq.html#cb1-216" tabindex="-1"></a>cutFs <span class="ot">=</span> <span class="fu">sort</span>(<span class="fu">list.files</span>(path.cut,<span class="at">pattern=</span><span class="st">&quot;_R1_001.fastq.gz&quot;</span>,<span class="at">full.names=</span><span class="cn">TRUE</span>))</span>
<span id="cb1-217"><a href="processing-raw-fastq.html#cb1-217" tabindex="-1"></a>cutRs <span class="ot">=</span> <span class="fu">sort</span>(<span class="fu">list.files</span>(path.cut,<span class="at">pattern=</span><span class="st">&quot;_R2_001.fastq.gz&quot;</span>,<span class="at">full.names=</span><span class="cn">TRUE</span>))</span>
<span id="cb1-218"><a href="processing-raw-fastq.html#cb1-218" tabindex="-1"></a>get.sample.name <span class="ot">=</span> <span class="cf">function</span>(fname)<span class="fu">strsplit</span>(<span class="fu">basename</span>(fname),<span class="st">&quot;_L001&quot;</span>)[[<span class="dv">1</span>]][<span class="dv">1</span>]</span>
<span id="cb1-219"><a href="processing-raw-fastq.html#cb1-219" tabindex="-1"></a>sample.names <span class="ot">=</span> <span class="fu">unname</span>(<span class="fu">sapply</span>(cutFs,get.sample.name))</span>
<span id="cb1-220"><a href="processing-raw-fastq.html#cb1-220" tabindex="-1"></a><span class="fu">head</span>(sample.names)</span>
<span id="cb1-221"><a href="processing-raw-fastq.html#cb1-221" tabindex="-1"></a></span>
<span id="cb1-222"><a href="processing-raw-fastq.html#cb1-222" tabindex="-1"></a><span class="fu">plotQualityProfile</span>(cutFs[<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>])<span class="co">#most reads very short, but of longer reads quality remains pretty high until 250bp</span></span>
<span id="cb1-223"><a href="processing-raw-fastq.html#cb1-223" tabindex="-1"></a><span class="fu">plotQualityProfile</span>(cutRs[<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>])<span class="co">#most reads very short, long read quality drops around 225bp</span></span>
<span id="cb1-224"><a href="processing-raw-fastq.html#cb1-224" tabindex="-1"></a></span>
<span id="cb1-225"><a href="processing-raw-fastq.html#cb1-225" tabindex="-1"></a>filtFs <span class="ot">=</span> <span class="fu">file.path</span>(path,<span class="st">&quot;filtered&quot;</span>,<span class="fu">basename</span>(cutFs))</span>
<span id="cb1-226"><a href="processing-raw-fastq.html#cb1-226" tabindex="-1"></a>filtRs <span class="ot">=</span> <span class="fu">file.path</span>(path,<span class="st">&quot;filtered&quot;</span>,<span class="fu">basename</span>(cutRs))</span>
<span id="cb1-227"><a href="processing-raw-fastq.html#cb1-227" tabindex="-1"></a></span>
<span id="cb1-228"><a href="processing-raw-fastq.html#cb1-228" tabindex="-1"></a><span class="do">################################################################################</span></span>
<span id="cb1-229"><a href="processing-raw-fastq.html#cb1-229" tabindex="-1"></a><span class="do">#### ------------------------- Filter and trim ---------------------------- ####</span></span>
<span id="cb1-230"><a href="processing-raw-fastq.html#cb1-230" tabindex="-1"></a><span class="do">################################################################################</span></span>
<span id="cb1-231"><a href="processing-raw-fastq.html#cb1-231" tabindex="-1"></a></span>
<span id="cb1-232"><a href="processing-raw-fastq.html#cb1-232" tabindex="-1"></a>out <span class="ot">=</span> <span class="fu">filterAndTrim</span>(cutFs, filtFs, cutRs, filtRs, <span class="at">maxN =</span> <span class="dv">0</span>, <span class="at">maxEE =</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>), <span class="at">truncQ =</span> <span class="dv">2</span>,</span>
<span id="cb1-233"><a href="processing-raw-fastq.html#cb1-233" tabindex="-1"></a>                   <span class="at">minLen =</span> <span class="dv">50</span>, <span class="at">rm.phix =</span> <span class="cn">TRUE</span>, <span class="at">compress =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-234"><a href="processing-raw-fastq.html#cb1-234" tabindex="-1"></a></span>
<span id="cb1-235"><a href="processing-raw-fastq.html#cb1-235" tabindex="-1"></a><span class="fu">head</span>(out)</span>
<span id="cb1-236"><a href="processing-raw-fastq.html#cb1-236" tabindex="-1"></a>exists <span class="ot">=</span> <span class="fu">file.exists</span>(filtFs)<span class="co">#all files have reads</span></span>
<span id="cb1-237"><a href="processing-raw-fastq.html#cb1-237" tabindex="-1"></a></span>
<span id="cb1-238"><a href="processing-raw-fastq.html#cb1-238" tabindex="-1"></a>errF <span class="ot">=</span> <span class="fu">learnErrors</span>(filtFs[exists],<span class="at">multithread =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-239"><a href="processing-raw-fastq.html#cb1-239" tabindex="-1"></a>errR <span class="ot">=</span> <span class="fu">learnErrors</span>(filtRs[exists],<span class="at">multithread =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-240"><a href="processing-raw-fastq.html#cb1-240" tabindex="-1"></a></span>
<span id="cb1-241"><a href="processing-raw-fastq.html#cb1-241" tabindex="-1"></a><span class="fu">plotErrors</span>(errF,<span class="at">nominalQ=</span><span class="cn">TRUE</span>)</span>
<span id="cb1-242"><a href="processing-raw-fastq.html#cb1-242" tabindex="-1"></a><span class="fu">plotErrors</span>(errR,<span class="at">nominalQ=</span><span class="cn">TRUE</span>)</span>
<span id="cb1-243"><a href="processing-raw-fastq.html#cb1-243" tabindex="-1"></a></span>
<span id="cb1-244"><a href="processing-raw-fastq.html#cb1-244" tabindex="-1"></a>derepFs <span class="ot">=</span> <span class="fu">derepFastq</span>(filtFs[exists], <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-245"><a href="processing-raw-fastq.html#cb1-245" tabindex="-1"></a>derepRs <span class="ot">=</span> <span class="fu">derepFastq</span>(filtRs[exists], <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-246"><a href="processing-raw-fastq.html#cb1-246" tabindex="-1"></a></span>
<span id="cb1-247"><a href="processing-raw-fastq.html#cb1-247" tabindex="-1"></a>dadaFs <span class="ot">=</span> <span class="fu">dada</span>(derepFs, <span class="at">err =</span> errF, <span class="at">multithread =</span> <span class="cn">TRUE</span>, <span class="at">pool =</span> <span class="st">&quot;pseudo&quot;</span>)</span>
<span id="cb1-248"><a href="processing-raw-fastq.html#cb1-248" tabindex="-1"></a>dadaRs <span class="ot">=</span> <span class="fu">dada</span>(derepRs, <span class="at">err =</span> errR, <span class="at">multithread =</span> <span class="cn">TRUE</span>, <span class="at">pool =</span> <span class="st">&quot;pseudo&quot;</span>)</span>
<span id="cb1-249"><a href="processing-raw-fastq.html#cb1-249" tabindex="-1"></a></span>
<span id="cb1-250"><a href="processing-raw-fastq.html#cb1-250" tabindex="-1"></a>mergers <span class="ot">=</span> <span class="fu">mergePairs</span>(dadaFs, derepFs, dadaRs, derepRs, <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-251"><a href="processing-raw-fastq.html#cb1-251" tabindex="-1"></a><span class="fu">names</span>(mergers) <span class="ot">=</span> sample.names[exists]</span>
<span id="cb1-252"><a href="processing-raw-fastq.html#cb1-252" tabindex="-1"></a>seqtab <span class="ot">=</span> <span class="fu">makeSequenceTable</span>(mergers)</span>
<span id="cb1-253"><a href="processing-raw-fastq.html#cb1-253" tabindex="-1"></a><span class="fu">sort</span>(<span class="fu">table</span>(<span class="fu">nchar</span>(<span class="fu">getSequences</span>(seqtab))))<span class="co">#no clear pattern of sequence length distribution, remove products under 100bp</span></span>
<span id="cb1-254"><a href="processing-raw-fastq.html#cb1-254" tabindex="-1"></a><span class="co"># seqtab2&lt;-seqtab[,nchar(colnames(seqtab)) %in% 100:457]</span></span>
<span id="cb1-255"><a href="processing-raw-fastq.html#cb1-255" tabindex="-1"></a></span>
<span id="cb1-256"><a href="processing-raw-fastq.html#cb1-256" tabindex="-1"></a>seqtab.nochim <span class="ot">=</span> <span class="fu">removeBimeraDenovo</span>(seqtab, <span class="at">method =</span> <span class="st">&quot;consensus&quot;</span>, <span class="at">multithread =</span> <span class="cn">TRUE</span>, <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-257"><a href="processing-raw-fastq.html#cb1-257" tabindex="-1"></a><span class="fu">sum</span>(seqtab.nochim)<span class="sc">/</span><span class="fu">sum</span>(seqtab) <span class="co">#91% of reads remain</span></span>
<span id="cb1-258"><a href="processing-raw-fastq.html#cb1-258" tabindex="-1"></a></span>
<span id="cb1-259"><a href="processing-raw-fastq.html#cb1-259" tabindex="-1"></a>getN <span class="ot">=</span> <span class="cf">function</span>(x) <span class="fu">sum</span>(<span class="fu">getUniques</span>(x))</span>
<span id="cb1-260"><a href="processing-raw-fastq.html#cb1-260" tabindex="-1"></a>out_ex <span class="ot">=</span> <span class="fu">row.names</span>(out)[exists]</span>
<span id="cb1-261"><a href="processing-raw-fastq.html#cb1-261" tabindex="-1"></a>track <span class="ot">=</span> <span class="fu">cbind</span>(out,<span class="fu">sapply</span>(dadaFs, getN),<span class="fu">sapply</span>(dadaRs,getN), <span class="fu">sapply</span>(mergers, getN), <span class="fu">rowSums</span>(seqtab.nochim))</span>
<span id="cb1-262"><a href="processing-raw-fastq.html#cb1-262" tabindex="-1"></a><span class="fu">colnames</span>(track) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;input&quot;</span>, <span class="st">&quot;filtered&quot;</span>, <span class="st">&quot;denoisedF&quot;</span>, <span class="st">&quot;denoisedR&quot;</span>, <span class="st">&quot;merged&quot;</span>, <span class="st">&quot;nochim&quot;</span>)</span>
<span id="cb1-263"><a href="processing-raw-fastq.html#cb1-263" tabindex="-1"></a></span>
<span id="cb1-264"><a href="processing-raw-fastq.html#cb1-264" tabindex="-1"></a></span>
<span id="cb1-265"><a href="processing-raw-fastq.html#cb1-265" tabindex="-1"></a>ps_base <span class="ot">=</span> <span class="fu">phyloseq</span>(<span class="fu">otu_table</span>(seqtab.nochim,<span class="at">taxa_are_rows =</span> <span class="cn">FALSE</span>))</span>
<span id="cb1-266"><a href="processing-raw-fastq.html#cb1-266" tabindex="-1"></a>dna <span class="ot">=</span> Biostrings<span class="sc">::</span><span class="fu">DNAStringSet</span>(<span class="fu">taxa_names</span>(ps_base))</span>
<span id="cb1-267"><a href="processing-raw-fastq.html#cb1-267" tabindex="-1"></a><span class="fu">names</span>(dna) <span class="ot">=</span> <span class="fu">taxa_names</span>(ps_base)</span>
<span id="cb1-268"><a href="processing-raw-fastq.html#cb1-268" tabindex="-1"></a>ps_base <span class="ot">=</span> <span class="fu">merge_phyloseq</span>(ps_base, dna)</span>
<span id="cb1-269"><a href="processing-raw-fastq.html#cb1-269" tabindex="-1"></a><span class="fu">taxa_names</span>(ps_base) <span class="ot">=</span> <span class="fu">paste0</span>(<span class="st">&quot;ASV&quot;</span>, <span class="fu">seq</span>(<span class="fu">ntaxa</span>(ps_base)))</span>
<span id="cb1-270"><a href="processing-raw-fastq.html#cb1-270" tabindex="-1"></a></span>
<span id="cb1-271"><a href="processing-raw-fastq.html#cb1-271" tabindex="-1"></a>ps_sub <span class="ot">=</span> <span class="fu">prune_taxa</span>(<span class="fu">taxa_sums</span>(ps_base) <span class="sc">&gt;</span> <span class="dv">2</span>, ps_base) <span class="co"># remove singleton and doubletons, 1/3 of taxa removed</span></span>
<span id="cb1-272"><a href="processing-raw-fastq.html#cb1-272" tabindex="-1"></a></span>
<span id="cb1-273"><a href="processing-raw-fastq.html#cb1-273" tabindex="-1"></a><span class="fu">taxa_names</span>(ps_sub) <span class="ot">=</span> <span class="fu">paste0</span>(<span class="st">&quot;ASV&quot;</span>, <span class="fu">seq</span>(<span class="fu">ntaxa</span>(ps_sub)))</span>
<span id="cb1-274"><a href="processing-raw-fastq.html#cb1-274" tabindex="-1"></a></span>
<span id="cb1-275"><a href="processing-raw-fastq.html#cb1-275" tabindex="-1"></a>ps_sub <span class="sc">%&gt;%</span></span>
<span id="cb1-276"><a href="processing-raw-fastq.html#cb1-276" tabindex="-1"></a>  <span class="fu">refseq</span>() <span class="sc">%&gt;%</span></span>
<span id="cb1-277"><a href="processing-raw-fastq.html#cb1-277" tabindex="-1"></a>  Biostrings<span class="sc">::</span><span class="fu">writeXStringSet</span>(<span class="st">&quot;/home/kvilleneuve/fish_edna/results/coi_dada2_biostring4annotation.fna&quot;</span>, <span class="at">append =</span> <span class="cn">FALSE</span>,</span>
<span id="cb1-278"><a href="processing-raw-fastq.html#cb1-278" tabindex="-1"></a>                              <span class="at">compress =</span> <span class="cn">FALSE</span>, <span class="at">compression_level =</span> <span class="cn">NA</span>, <span class="at">format =</span> <span class="st">&quot;fasta&quot;</span>)</span>
<span id="cb1-279"><a href="processing-raw-fastq.html#cb1-279" tabindex="-1"></a><span class="fu">saveRDS</span>(ps_sub, <span class="at">file =</span> <span class="st">&quot;/home/kvilleneuve/fish_edna/results/coi_dada2_rdpraw_phylo.rds&quot;</span>)</span></code></pre></div>
</div>
<div id="barque" class="section level2 unnumbered hasAnchor">
<h2>barque<a href="processing-raw-fastq.html#barque" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>NB. Barque will only work on GNU Linux or OSX</p>
<ol style="list-style-type: decimal">
<li>Required dependencies</li>
</ol>
<ul>
<li>bash 4+</li>
<li>python 3.5+ (you can use miniconda3 to install python)</li>
<li>python distutils package</li>
<li>R 3+ (ubuntu/mint: sudo apt-get install r-base-core)</li>
<li>java (ubuntu/mint: sudo apt-get install default-jre)</li>
<li>gnu parallel</li>
<li>flash (read merger) v1.2.11+
<ul>
<li>Add the following to bashrc configuration file <code>export PATH=/home/user/FLASH-1.2.11:$PATH</code></li>
</ul></li>
<li>vsearch v2.14.2+ (Barque will not work with older versions of vsearch)
<ul>
<li>Depending on how vsearch is installed either export PATH to location of vsearch or activate base conda environnement</li>
</ul></li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li>Download a copy of the Barque repository</li>
</ol>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="processing-raw-fastq.html#cb2-1" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/enormandeau/barque</span></code></pre></div>
<ol start="3" style="list-style-type: decimal">
<li>Get or prepare the database(s) (see Formatting database section below) and deposit the fasta.gz file in the 03_databases folder and give it a name that matches the information of the 02_info/primers.csv file.</li>
</ol>
<ul>
<li><a href="https://www.ibis.ulaval.ca/services/bioinformatique/barque_databases/">Link</a> to BOLD database</li>
</ul>
<ol start="4" style="list-style-type: decimal">
<li>Modify the following parameters :</li>
</ol>
<p><strong>In the 02_info/primers.csv</strong></p>
<ul>
<li>for COI marker :</li>
</ul>
<p><code>COI_kv,CGTATTTGGYGCYTGRGCCGGRATAGT,CARAARCTYATRTTRTTYATTCG,100,450,bold,0.97,0.9,0.85</code></p>
<ul>
<li>for 12S marker</li>
</ul>
<p><code>12s200pb,GTCGGTAAAACTCGTGCCAGC,CATAGTGGGGTATCTAATCCCAGTTTG,150,350,12S,0.98,0.9,0.85</code></p>
<p><strong>In the 02_info/barque_config.sh</strong>
NCPUS=40
CROP_LENGTH=500
MAX_PRIMER_DIFF=11 Maximum number of differences allowed between primer and sequence</p>
<p>(MAX_PRIMER_DIFF=9)</p>
<ol start="5" style="list-style-type: decimal">
<li>Launch Barque</li>
</ol>
<p>Recommended parameters :</p>
<p>From the Github directory</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="processing-raw-fastq.html#cb3-1" tabindex="-1"></a><span class="ex">./barque</span> 02_info/barque_config.sh</span></code></pre></div>
<p>Once the pipeline has finished running, all result files are found in the 12_results folder.
After a run, it is recommended to make a copy of this folder with some additional info</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="processing-raw-fastq.html#cb4-1" tabindex="-1"></a><span class="fu">cp</span> <span class="at">-r</span> 12_results results_PROJECT_NAME_DATE_SOME_ADDITIONAL_INFO</span></code></pre></div>

</div>
</div>
<hr>
<center>
  <div class="footer">
      Karine Villeneuve
      <p : id="date"></p>
<script>
  // Get current date and time
//  var now = new Date();
//  var date = now.toLocaleString();
//  n =  new Date();
//  y = n.getFullYear();
//  m = n.getMonth();
//  d = n.getDate();
//  document.getElementById("date").innerHTML = d + "/" + m + "/" + y;
  n = new Date().toDateString()
  document.getElementById("date").innerHTML = n
  // Insert date and time into HTML
//  document.getElementById("date").innerHTML = date;
</script>
  </div>
</center>
            </section>

          </div>
        </div>
      </div>
<a href="required-files-scripts-and-programs.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="taxonomic-classification.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/karinevilleneuve/fish_eDNA/master/02_processing_fastq.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
