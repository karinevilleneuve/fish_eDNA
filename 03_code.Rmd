# Supplementary workflow {-}

## Curating databases for distance matrix  {-}

Required files : 

- barque COI [3](https://www.ibis.ulaval.ca/services/bioinformatique/barque_databases/) (`barque_coi.fasta`)
- RDP COI V5.1.0 [5](https://github.com/terrimporter/CO1Classifier/releases/tag/RDP-COI-v5.1.0) (`rdp_coi.fasta`)

### RDP {-}

1. Filter out sequence which do not belong to class Actinopteri

```{bash, eval = FALSE}
seqkit grep -r -n -p '.*Actinopteri*' rdp_coi.fasta -o chord_rdp_coi.fasta
```

2. Extract sequences header and print into txt file

```{bash, eval = FALSE}
grep ">" chord_rdp_coi.fasta | sed -e "s/>//" > rdp_coi_header.txt
```

3. The file with the sequence headers can then be passed to R to generate a list of which headers to keep. As per methodology by Edgar (2018), because the databases have a highly uneven numbers of sequences per genus, a subset is create by imposing a maximum of 10 sequences per genus. Headers are sampled at random to meet this constraint.

```{r, eval = FALSE}

#### ------------------------- Load libraries ------------------------------------------------------------------####  

library(dplyr)
library(tidyr)

#### ------------------------- Load databases sequence header -------------------------------------------------- #### 

rdpcoi = read.table("/home/kvilleneuve/fish_edna/database/taxxi_cvi/COI_DB/rdp_coi_header.txt",sep = ";")

#### ------------------------- Format dataframes -------------------------------------------------------------- #### 
names(rdpcoi) = c("ID", "Cellular_organism","Superkingdom", "Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "Species")
rdp_coi_actino = subset(rdpcoi, Class == "Actinopteri")

#### ------------------------- Random sampling  --------------------------------------------------------------- #### 

random_sampling_list = list()
i = 0 

for (genus in unique(rdp_coi_actino$Genus)){
  i = i + 1
  sub_df = subset(rdp_coi_actino, Genus == genus)
  if (nrow(sub_df) > 10) {
    rand_sub_df = sub_df[sample(nrow(sub_df), size=10), ] 
  } else {
    rand_sub_df = sub_df
  }
    random_sampling_list[[i]] = rand_sub_df
}

#### ------------------------- Generate list of headers to keep ----------------------------------------------- #### 

df = do.call("rbind", random_sampling_list)

df = df %>% unite("sequence_header", ID:Species, remove = FALSE, sep  = ";")
write.table(df$sequence_header, "/home/kvilleneuve/fish_edna/database/taxxi_cvi/COI_DB/rdp_coi_headers_to_keep.txt", col.names = FALSE, row.names = FALSE, quote = FALSE)
```

4. Pass the file generated by the R script to seqkit to create a subset database 

```{bash, eval = FALSE}
seqkit grep -nrf rdp_coi_headers_to_keep.txt chord_rdp_coi.fasta -o curated_rdp_coi.fasta
``` 

### Barque {-}

1. Remove sequence of taxa which do not belong to phylum Chordata

```{bash, eval = FALSE}
seqkit grep -r -n -p '.*chordata_*' barque_coi.fasta -o chord_barque_coi.fasta
```

2. Add unique ID to every sequence header, this is required to randomly sample 10 sequences per genus

```{bash, eval = FALSE}
awk '/^>/{sub(">", ">"++i"_")}1' chord_barque_coi.fasta > chord_barque_coi_ID.fasta
```

3. Extract sequences header and print into txt file 

```{bash, eval = FALSE}
grep ">" chord_barque_coi_ID.fasta | sed -e "s/>//" > barque_coi_ID_header.txt
grep ">" rdp_coi.fasta | sed -e "s/>//" > rdp_coi_header.txt
```

4. The file with the sequence headers can then be passed to R to generate a list of which headers to keep. As per methodology by Edgar (2018), because the databases have a highly uneven numbers of sequences per genus, a subset is create by imposing a maximum of 10 sequences per genus. Headers are sampled at random to meet this constraint.

```{r, eval = FALSE}
#### ------------------------- Load libraries ------------------------------------------------------------------####  

library(dplyr)

#### ------------------------- Load databases sequence header -------------------------------------------------- #### 


barquecoi = read.table("/home/kvilleneuve/fish_edna/database/taxxi_cvi/COI_DB/barque_coi_ID_header.txt", sep = "_")
rdpcoi = read.table("/home/kvilleneuve/fish_edna/database/taxxi_cvi/COI_DB/rdp_coi_header.txt",sep = ";")

#### ------------------------- Format dataframes for merging --------------------------------------------------- #### 

# The sequence headers of the COI database used by barque has the following format : Phylum_Genus_Species
# Therefore, to keep only sequence belonging to class Actinopteri 
# I am merging the header from the barque COI database with headers from the RDP COI database to get complete 
# taxonomic rank

barquecoi$Species = paste(barquecoi$V2, barquecoi$V3, sep = "_") # Create column with specie name 
barquecoi_unique = barquecoi[!duplicated(barquecoi), ] # Keeping only unique value

# Add column names to RDP database 
names(rdpcoi) = c("ID", "Cellular_organism","Superkingdom", "Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "Species")
rdpcoi_noID = subset(rdpcoi, select = -c(ID)) # Remove column ID (they are unique values)
rdpcoi_unique = rdpcoi_noID[!duplicated(rdpcoi_noID), ] # Keeping only unique value

#### ------------------------- Merge dataframes  -------------------------------------------------------------- #### 

comb_df = merge(barquecoi_unique, rdpcoi_unique, by = "Species", all.y = FALSE )

#### ------------------------- Random sampling  --------------------------------------------------------------- #### 

random_sampling_list = list()
i = 0 

for (genus in unique(comb_df$Genus.x)){
  i = i + 1
  sub_df = subset(comb_df, Genus.x == genus)
  if (nrow(sub_df) > 10) {
    rand_sub_df = sub_df[sample(nrow(sub_df), size=10), ] 
  } else {
    rand_sub_df = sub_df
  }
    random_sampling_list[[i]] = rand_sub_df
}

df = do.call("rbind", random_sampling_list)

#### ------------------------- Generate list of headers to keep ----------------------------------------------- #### 

df$barque_coi_header = paste(df$ID, df$Phylum.x, df$Species, sep = "_")

write.table(df$barque_coi_header, "/home/kvilleneuve/fish_edna/database/taxxi_cvi/COI_DB/barque_coi_headers_to_keep.txt",col.names = FALSE, row.names = FALSE, quote = FALSE)
```

5. Pass the file generated by the R script to seqkit to create a subset database. 

```{bash, eval = FALSE}
seqkit grep -nrf barque_coi_headers_to_keep.txt chord_barque_coi.fasta -o curated_barque_coi.fasta
``` 


## Comparing pipelines with available databases {-}

### DADA2 {-}

#### 12S {-}

#### COI {-}

839 ASV | from these 839 ASVs, 20 (2.38 %) are species with a bootstrap level above 70 % | from these 20 species, 8 (40 %) are from class actinopteri | from these 8 actinopteri, 7 (87.5 %) are species of freshwater fishes found in Alberta. 

### Barque {-}

## Curating databases for Alberta freshwater fish {-}

Using `seqkit` tool to filter databases in order to keep only sequences of freshwater fishes found in Alberta 

seqkit grep -i -f ids.txt test.fa 

```{bash, eval = FALSE}
seqkit grep -nrf ID_barque_12S.txt barque_12S.fasta -o alberta_barque_12S.fasta
seqkit grep -nrf ID_barque_COI.txt bold_coi_for_barque_2023-09-12.fasta -o alberta_barque_COI.fasta
```

For RDP 

```{bash, eval = FALSE}
sed -i 's/ /;/g' RDP_COI.fasta
sed -i 's/ /;/g' ID_RDP_COI.txt
seqkit grep -nrf ID_RDP_COI.txt RDP_COI.fasta -o alberta_RDP_COI.fasta

sed -i 's/\t/;/g' 12S_rdp.fasta
sed -i 's/\t/;/g' ID_RDP_12S.txt
seqkit grep -nrf ID_RDP_12S.txt 12S_rdp.fasta -o alberta_RDP_12S.fasta
```


